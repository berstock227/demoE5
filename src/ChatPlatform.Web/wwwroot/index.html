<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Platform Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .content {
            display: flex;
            height: 600px;
        }
        .sidebar {
            width: 300px;
            border-right: 1px solid #ddd;
            padding: 20px;
            background: #f8f9fa;
        }
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #ddd;
            background: #f8f9fa;
        }
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 70%;
        }
        .message.sent {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        .message.received {
            background: #e9ecef;
            color: #333;
        }
        .message-input {
            padding: 20px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }
        .message-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .message-input button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .message-input button:hover {
            background: #0056b3;
        }
        .room-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
        }
        .room-item:hover {
            background: #e9ecef;
        }
        .room-item.active {
            background: #007bff;
            color: white;
        }
        .status {
            padding: 8px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        .status.connected {
            background: #28a745;
            color: white;
        }
        .status.disconnected {
            background: #dc3545;
            color: white;
        }
        .auth-section {
            padding: 20px;
            text-align: center;
        }
        .auth-section input {
            margin: 5px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .auth-section button {
            margin: 5px;
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .auth-section button:hover {
            background: #0056b3;
        }
        .rooms-section {
            display: none;
        }
        .status-section {
            display: none;
        }
        .message-input {
            display: none;
        }
        .create-room {
            margin-bottom: 20px;
        }
        .create-room input {
            width: 60%;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .create-room button {
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .create-room button:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Chat Platform Demo</h1>
            <p>Real-time messaging with SignalR</p>
        </div>
        
        <div class="content">
            <div class="sidebar">
                <div id="authSection" class="auth-section">
                    <h3>Login/Register</h3>
                    <input type="email" id="emailInput" placeholder="Email" value="demo@example.com">
                    <input type="password" id="passwordInput" placeholder="Password" value="password123">
                    <br>
                    <button onclick="login()">Login</button>
                    <button onclick="register()">Register</button>
                </div>
                
                <div id="roomsSection" class="rooms-section">
                    <h3>Rooms</h3>
                    <div class="create-room">
                        <input type="text" id="roomNameInput" placeholder="Room name">
                        <button onclick="createRoom()">Create Room</button>
                    </div>
                    <div id="roomsList"></div>
                    <div id="connectionStatus" class="status disconnected">Disconnected</div>
                </div>
            </div>
            
            <div class="chat-area">
                <div class="chat-header">
                    <h3 id="currentRoom">Select a room to start chatting</h3>
                </div>
                
                <div id="messages" class="messages">
                    <div class="message received">
                        <strong>System:</strong> Welcome to Chat Platform! Please login and select a room to start chatting.
                    </div>
                </div>
                
                <div id="messageInput" class="message-input">
                    <input type="text" id="messageText" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        let connection = null;
        let currentUser = null;
        let currentRoom = null;
        let rooms = [];
        
        // Handle page unload and visibility change
        window.addEventListener('beforeunload', function() {
            if (connection && connection.state === 'Connected') {
                // Force disconnect to trigger OnDisconnectedAsync
                console.log('Page unloading, forcing SignalR disconnect');
                connection.stop();
            }
        });
        
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && connection && connection.state === 'Connected') {
                // Page is hidden (tab switched or minimized)
                console.log('Page hidden, updating presence to away');
                connection.invoke('updatePresence', 'away');
            } else if (!document.hidden && connection && connection.state === 'Connected') {
                // Page is visible again
                console.log('Page visible, updating presence to online');
                connection.invoke('updatePresence', 'online');
            }
        });

        // Authentication functions
        async function login() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data;
                    localStorage.setItem('token', data.accessToken);
                    showAuthenticatedUI();
                    connectToSignalR();
                    loadRooms();
                } else {
                    alert('Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login error');
            }
        }

        async function register() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data;
                    localStorage.setItem('token', data.accessToken);
                    showAuthenticatedUI();
                    connectToSignalR();
                    loadRooms();
                } else {
                    alert('Registration failed');
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration error');
            }
        }

        function logout() {
            currentUser = null;
            currentRoom = null;
            rooms = [];
            localStorage.removeItem('token');
            if (connection) {
                connection.stop();
            }
            showUnauthenticatedUI();
        }

        function showAuthenticatedUI() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('roomsSection').style.display = 'block';
            document.getElementById('messageInput').style.display = 'flex';
        }

        function showUnauthenticatedUI() {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('roomsSection').style.display = 'none';
            document.getElementById('messageInput').style.display = 'none';
            document.getElementById('currentRoom').textContent = 'Select a room to start chatting';
            document.getElementById('messages').innerHTML = '<div class="message received"><strong>System:</strong> Welcome to Chat Platform! Please login and select a room to start chatting.</div>';
        }

        // SignalR connection
        function connectToSignalR() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('No token available for SignalR connection');
                return;
            }

            console.log('Attempting to connect to SignalR...');
            
            connection = new signalR.HubConnectionBuilder()
                .withUrl(`/chathub?access_token=${token}`, { 
                    skipNegotiation: false,
                    transport: signalR.HttpTransportType.WebSockets
                })
                .withAutomaticReconnect([0, 2000, 10000, 30000])
                .configureLogging(signalR.LogLevel.Information)
                .build();

            connection.on('MessageReceived', (message) => {
                console.log('Received message:', message);
                addMessage(message, message.senderId === currentUser?.userId);
            });

            connection.on('UserJoinedRoom', (userId, roomId) => {
                console.log('User joined room:', userId, roomId);
                addSystemMessage(`${userId} joined the room`);
            });

            connection.on('UserLeftRoom', (userId, roomId) => {
                console.log('User left room:', userId, roomId);
                addSystemMessage(`${userId} left the room`);
            });

            connection.on('UserTyping', (userId, roomId, isTyping) => {
                console.log('Typing indicator:', userId, roomId, isTyping);
                // Handle typing indicator
            });

            connection.on('RoomJoined', (roomId) => {
                console.log('Successfully joined room:', roomId);
                // Room joined successfully
            });

            connection.on('RoomLeft', (roomId) => {
                console.log('Successfully left room:', roomId);
                // Room left successfully
            });

            connection.onreconnecting((error) => {
                console.log('SignalR reconnecting...', error);
                updateConnectionStatus(false);
            });

            connection.onreconnected((connectionId) => {
                console.log('SignalR reconnected:', connectionId);
                updateConnectionStatus(true);
            });

            connection.start()
                .then(() => {
                    updateConnectionStatus(true);
                    console.log('SignalR Connected successfully!');
                })
                .catch(err => {
                    console.error('SignalR connection error:', err);
                    updateConnectionStatus(false);
                });

            connection.onclose((error) => {
                console.log('SignalR connection closed:', error);
                updateConnectionStatus(false);
            });
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'status connected';
                status.textContent = 'Connected';
            } else {
                status.className = 'status disconnected';
                status.textContent = 'Disconnected';
            }
        }

        // Room management
        async function loadRooms() {
            try {
                const token = localStorage.getItem('token');
                console.log('Loading rooms with token:', token ? 'valid' : 'missing');
                
                const response = await fetch('/api/chat/rooms', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                console.log('Load rooms response status:', response.status);
                
                if (response.ok) {
                    const roomsData = await response.json();
                    console.log('Rooms loaded:', roomsData);
                    rooms = Array.isArray(roomsData) ? roomsData : [];
                    displayRooms();
                } else {
                    const errorText = await response.text();
                    console.error('Failed to load rooms:', response.status, errorText);
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }

        function displayRooms() {
            const roomsList = document.getElementById('roomsList');
            roomsList.innerHTML = '';
            
            if (rooms.length === 0) {
                roomsList.innerHTML = '<p>No rooms available. Create one!</p>';
                return;
            }
            
            rooms.forEach(room => {
                const roomDiv = document.createElement('div');
                roomDiv.className = 'room-item';
                roomDiv.textContent = room.name;
                roomDiv.onclick = () => selectRoom(room);
                roomsList.appendChild(roomDiv);
            });
        }

        async function createRoom() {
            const name = document.getElementById('roomNameInput').value.trim();
            if (!name) {
                alert('Please enter a room name');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/chat/rooms', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        name: name, 
                        description: `Room: ${name}`,
                        type: 0 
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('roomNameInput').value = '';
                    
                    // Add the new room to the local rooms array immediately
                    if (result.room) {
                        const newRoom = {
                            id: result.roomId,
                            name: result.room.name,
                            description: result.room.description,
                            type: result.room.type
                        };
                        rooms.push(newRoom);
                        displayRooms();
                    }
                    
                    // Also reload rooms from server to ensure consistency
                    await loadRooms();
                    alert('Room created successfully!');
                } else {
                    alert('Failed to create room');
                }
            } catch (error) {
                console.error('Error creating room:', error);
                alert('Error creating room');
            }
        }

        async function selectRoom(room) {
            currentRoom = room;
            document.getElementById('currentRoom').textContent = room.name;
            
            // Update active room in sidebar
            document.querySelectorAll('.room-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find the clicked room item and make it active
            const roomItems = document.querySelectorAll('.room-item');
            for (let item of roomItems) {
                if (item.textContent === room.name) {
                    item.classList.add('active');
                    break;
                }
            }
            
            // Join room
            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                try {
                    await connection.invoke('JoinRoom', room.id);
                    loadRoomMessages(room.id);
                } catch (error) {
                    console.error('Error joining room:', error);
                }
            } else {
                // If SignalR is not connected, just load messages
                loadRoomMessages(room.id);
            }
        }

        async function loadRoomMessages(roomId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/chat/rooms/${roomId}/messages`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const messages = await response.json();
                    document.getElementById('messages').innerHTML = '';
                    messages.forEach(message => {
                        addMessage(message, message.senderId === currentUser.userId);
                    });
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Messaging
        async function sendMessage() {
            if (!currentRoom) {
                alert('Please select a room first');
                return;
            }
            
            if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                alert('SignalR connection not available. Please wait for connection.');
                return;
            }
            
            const text = document.getElementById('messageText').value.trim();
            if (!text) return;
            
            try {
                // Send via SignalR
                await connection.invoke('SendMessage', currentRoom.id, text);
                
                // Clear input immediately for better UX
                document.getElementById('messageText').value = '';
                
                // Also send via API for persistence
                const token = localStorage.getItem('token');
                const apiResponse = await fetch('/api/chat/messages', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        roomId: currentRoom.id,
                        content: text,
                        messageType: 0
                    })
                });
                
                if (!apiResponse.ok) {
                    console.warn('API message persistence failed, but SignalR message was sent');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message: ' + error.message);
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function addMessage(message, isSent) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            messageDiv.innerHTML = `<strong>${message.senderId || 'Unknown'}:</strong> ${message.content}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addSystemMessage(text) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message received';
            messageDiv.innerHTML = `<strong>System:</strong> ${text}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Check if user is already authenticated
        window.onload = function() {
            const token = localStorage.getItem('token');
            if (token) {
                // Verify token and restore session
                fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Invalid token');
                })
                .then(user => {
                    currentUser = user;
                    showAuthenticatedUI();
                    connectToSignalR();
                    loadRooms();
                })
                .catch(() => {
                    localStorage.removeItem('token');
                    showUnauthenticatedUI();
                });
            }
        };
    </script>
</body>
</html>
